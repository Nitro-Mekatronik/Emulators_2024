#include "ESL.h"
#include "LIN_Slave.h"
#include "SmartLED.h"
#include "main.h"
#include <string.h>

//**************************************************

LIN_FRAME_t linFrame;

uint8_t rxBuffer[8];
uint8_t request = CMD_NULL, keyStat = KEY_EXIT;
uint8_t resC1_Index = 0, resC1_Len = EXIT_KEY_LEN;
uint8_t resActive = 0;

uint8_t resInsertKey_C1[INSERT_KEY_LEN][8] = {
    // 2 BYTE FOR 0xC1 or 8 BYTE FOR 0x37
    {0x08, 0x02, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x03, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x04, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x05, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x06, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x07, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x08, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x09, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x0A, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x0B, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x0C, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x0D, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x0E, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x07, 0x0F, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x10, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x07, 0x11, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x12, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
};

uint8_t resExitKey_C1[EXIT_KEY_LEN][8] = {
    // 2 BYTE FOR 0xC1 or 8 BYTE FOR 0x37
    {0x08, 0x01, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x02, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x03, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x08, 0x04, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x08, 0x05, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x07, 0x06, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x07, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x07, 0x08, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x09, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x07, 0x0A, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x0B, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x07, 0x0C, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x07, 0x0D, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x87, 0x0E, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x88, 0x0F, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x88, 0x10, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x88, 0x11, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x88, 0x12, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x88, 0x13, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x88, 0x14, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x88, 0x15, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x88, 0x16, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x88, 0x17, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x88, 0x18, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x88, 0x19, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x88, 0x1A, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
    {0x84, 0x1B, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00}, {0x84, 0x1C, 0x78, 0xD4, 0x01, 0xD2, 0x8B, 0x00},
};

void ESL_Init(void)
{
    UB_LIN_Slave_Init();
}

void ESL_Receive(void)
{
    request = CMD_NULL;

    // LIN ID range & Data Length (ID 0x00-0x1F: 2 bytes, 0x20-0x2F: 4 bytes, 0x30-0x3F: 8 bytes)

    switch (linFrame.frame_id)
    {

    case 0x11:
        linFrame.data_len = 2;
        request = LIN_RECEIVE_CMD;
        break;

    case 0xC1:
        linFrame.data_len = 2;
        request = LIN_REQ_DATA;
        break;

    case 0x2E:
        linFrame.data_len = 8;
        request = LIN_RECEIVE_CMD;
        break;

    case 0x32:
        linFrame.data_len = 8;
        request = LIN_RECEIVE_CMD;
        break;

    case 0x61:
        linFrame.data_len = 4;
        request = LIN_RECEIVE_CMD;
        break;

    case 0x6F:
        linFrame.data_len = 2;
        request = LIN_RECEIVE_CMD;
        break;

    case 0x37:
        linFrame.data_len = 8;
        request = LIN_REQ_DATA;
        break;

    case 0xB1:
    case 0xF5:
        linFrame.data_len = 8;
        request = LIN_RECEIVE_CMD;
        break;
    }

    if (request == LIN_RECEIVE_CMD)
    {
        if (UB_LIN_ReceiveData(&linFrame) == LIN_OK)
        {
            switch (linFrame.frame_id)
            {
            case 0x11:
            case 0x2E:
            case 0x32:
            case 0x61:
            case 0x6F:
                break;

            case 0xB1:
                break;

            case 0xF5:
                if ((linFrame.data[0] == 0x22) || (linFrame.data[0] == 0x41))
                {
                    keyStat = KEY_INSERT;
                    resC1_Len = INSERT_KEY_LEN;
                    SmartLED_SetMode(LED_G, LED_MODE_ON);
                }
                else if (linFrame.data[0] == 0x05)
                {
                    keyStat = KEY_EXIT;
                    resC1_Len = EXIT_KEY_LEN;
                    SmartLED_SetMode(LED_G, LED_MODE_BLINK_SLOW);
                }
                else
                {
                    SmartLED_SetMode(LED_G, LED_MODE_OFF);
                    break;
                }

                resActive = 0x01;
                resC1_Index = 0;
                break;
            }
        }
    }
    else if (request == LIN_REQ_DATA)
    {
        if (resActive == 0x01)
        {
            if (linFrame.frame_id == 0xC1)
            {
                linFrame.data_len = 2;
                if (keyStat == KEY_INSERT)
                {
                    memcpy(linFrame.data, &resInsertKey_C1[resC1_Index][0], 2);
                }
                else
                {
                    memcpy(linFrame.data, &resExitKey_C1[resC1_Index][0], 2);
                }

                if (++resC1_Index >= resC1_Len)
                {
                    resC1_Index = 0;
                    resActive = 0;
                }
            }
            else if (linFrame.frame_id == 0x37)
            {
                linFrame.data_len = 8;

                if (keyStat == KEY_INSERT)
                {
                    memcpy(linFrame.data, &resInsertKey_C1[resC1_Index][0], 8);
                }
                else
                {
                    memcpy(linFrame.data, &resExitKey_C1[resC1_Index][0], 8);
                }

                if (++resC1_Index >= resC1_Len)
                {
                    resC1_Index = 0;
                    resActive = 0;
                }
            }

            UB_LIN_SendData(&linFrame);
            request = CMD_NULL;
        }
    }
}

void ESL_Update(void)
{
}
