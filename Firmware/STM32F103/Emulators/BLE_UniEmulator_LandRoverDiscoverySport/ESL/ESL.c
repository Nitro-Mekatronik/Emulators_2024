#include "ESL.h"
#include "LIN_Slave.h"
#include "SmartLED.h"
#include "main.h"
#include <string.h>

extern CAN_HandleTypeDef hcan;

typedef struct
{
    uint8_t repet;
    uint8_t data[8];
} CanTxMsg;

CAN_TxHeaderTypeDef TxHeader;
CAN_RxHeaderTypeDef RxHeader;
uint32_t TxMailbox;
uint8_t TxData[8];
uint8_t RxData[8];

const CanTxMsg resCmd1 = {3, {0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00}};
const CanTxMsg resCmd2[] = {
    {4, {0x02, 0x67, 0x91, 0x7B, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0x67, 0x53, 0x7B, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0x67, 0x53, 0x3D, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0x29, 0x53, 0x3D, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0x29, 0x15, 0x3D, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0x29, 0x15, 0xFE, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0xEA, 0x15, 0xFE, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0xEA, 0xD6, 0xFE, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0xEA, 0xD6, 0xC0, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0xAC, 0xD6, 0xC0, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0xAC, 0x98, 0xC0, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0xAC, 0x98, 0x84, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0x6E, 0x98, 0x84, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0x6E, 0x5A, 0x84, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0x6E, 0x5A, 0x46, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0x30, 0x5A, 0x46, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0x30, 0x1C, 0x46, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0x30, 0x1C, 0x08, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0xF1, 0x1C, 0x08, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0xF1, 0xDD, 0x08, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0xF1, 0xDD, 0xC9, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0xB5, 0xDD, 0xC9, 0x09, 0x10, 0x00, 0x00}},
    {4, {0x02, 0xB5, 0x9F, 0xC9, 0x09, 0x10, 0x00, 0x00}}, {4, {0x02, 0xB5, 0x9F, 0x8B, 0x09, 0x10, 0x00, 0x00}}
};

const CanTxMsg resCmd3 = {20, {0x00, 0x02, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00}};
const CanTxMsg resCmd4 = {10, {0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00}};

uint8_t cmd2Index = 0;

//**************************************************

// LIN_FRAME_t linFrame;

void CanSenderMsg(const CanTxMsg *msg)
{
    TxHeader.DLC = 8;
    TxHeader.RTR = CAN_RTR_DATA;
    TxHeader.IDE = CAN_ID_STD;

    for (uint8_t n = 0; n < msg->repet; n++)
    {
        TxHeader.StdId = 0x28;
        HAL_CAN_AddTxMessage(&hcan, &TxHeader, msg->data, &TxMailbox);
        while (HAL_CAN_IsTxMessagePending(&hcan, TxMailbox))
        {
            ;
        }

        HAL_Delay(1);

        TxHeader.StdId = 0x4F6;
        HAL_CAN_AddTxMessage(&hcan, &TxHeader, msg->data, &TxMailbox);
        while (HAL_CAN_IsTxMessagePending(&hcan, TxMailbox))
        {
            ;
        }
        HAL_Delay(1);
    }
}

//**************************************************

void ESL_Init(void)
{
    HAL_CAN_Start(&hcan);
}

//**************************************************

void ESL_Receive(CAN_HandleTypeDef *hcan)
{
    if (HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO0, &RxHeader, RxData) == HAL_OK)
    {

        if ((RxHeader.StdId == 0x20) || (RxHeader.StdId == 0xC0) || (RxHeader.StdId == 0x140) ||
            (RxHeader.StdId == 0x150) || (RxHeader.StdId == 0x170))
        {
            if ((RxData[0] == 0x00) || (RxData[0] == 0x01) || (RxData[0] == 0x03) || (RxData[0] == 0x04))
            {
                CanSenderMsg(&resCmd1);
                CanSenderMsg(&resCmd2[cmd2Index++]);
                if (cmd2Index >= 24)
                    cmd2Index = 0;
                CanSenderMsg(&resCmd3);
                CanSenderMsg(&resCmd4);
            }
        }
    }
}

//**************************************************

void ESL_Update(void)
{
}

//**************************************************
